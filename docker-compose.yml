services:
  control:
    image: chourmovs/azursmartmix-control:latest
    container_name: azursmartmix_control
    environment:
      SCHED_BASE_URL: "http://azursmartmix_scheduler:8001"
      ENGINE_CONTAINER: "azursmartmix_engine"
      SCHEDULER_CONTAINER: "azursmartmix_scheduler"
      UI_HOST: "0.0.0.0"
      UI_PORT: "8088"
      API_PREFIX: "/api"
      LOG_TAIL_LINES_DEFAULT: "400"
      LOG_TAIL_LINES_MAX: "2000"
      AZURSMARTMIX_REPO: "chourmovs/azursmartmix"
      AZURSMARTMIX_IMAGE: "chourmovs/azursmartmix:beta1"   # fallback par d√©faut

      COMPOSE_PATH: "/compose/docker-compose.yml"
      COMPOSE_SERVICE_ENGINE: "azursmartmix_engine"
      COMPOSE_SERVICE_SCHEDULER: "azursmartmix_scheduler"

      ICECAST_PUBLIC_URL: "http://chourmovs.ddnsfree.com:8000/gst-test.mp3"
      ICECAST_HOST: "web"
      ICECAST_PORT: "8000"
      ICECAST_MOUNT: "/gst-test.mp3"
      ICECAST_SCHEME: "http"
      ICECAST_STATUS_PATH: "/status-json.xsl"

      # --- NEW: host project directory + target image for update ---
      AZURAMIX_DIR: "/var/azuramix"
      AZURSMARTMIX_IMAGE: "chourmovs/azursmartmix:beta1"

    ports:
      - "8088:8088"

    volumes:
      # IMPORTANT: RW required for start/stop/up/down/recreate via docker api/cli
      - /var/run/docker.sock:/var/run/docker.sock:rw

      # runtime config
      - ./config/config.yml:/config/config.yml:ro

      # existing compose file mount (kept)
      - ../docker-compose.yml:/compose/docker-compose.yml:ro

      # NEW: host project dir (ro is enough to run docker compose there)
      - /var/azuramix:/var/azuramix:ro

    networks:
      - azursmartmix_net

    restart: unless-stopped

networks:
  azursmartmix_net:
    external: true
    name: azuracast_default
